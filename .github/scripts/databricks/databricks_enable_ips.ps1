Param (
    [string] [Parameter(Mandatory = $true)] $Environment,
    [string] [Parameter(Mandatory = $true)] $DatabricksWorkspace,
    [string] [Parameter(Mandatory = $false)] $DatabricksToken,
    [int]    [Parameter(Mandatory = $true)] $EnablePowerBI,
    [string] [Parameter(Mandatory = $false)] $NATPublicIP
)

write-host '-------------------------------------------------------------'
write-host "Working on *${Environment}* Environment."
write-host '-------------------------------------------------------------'

if (-not $DatabricksToken) {
    Write-Host "Databricks token not provided. Retrieving token using Azure CLI..."
    $DatabricksToken = az account get-access-token --resource=2ff814a6-3304-4ab8-85cb-cd0e6f879c1d --query accessToken --output tsv
    Write-Output "Databricks token obtained successfully."
    if (-not $DatabricksToken) {
        Write-Error "Failed to retrieve Databricks token using Azure CLI. Please provide a valid token or ensure you are logged in to Azure CLI with the necessary permissions."
        exit 1
    }
}
$header = @{
    Authorization  = "Bearer $DatabricksToken"
    "Content-Type" = "application/json"
}


$bodyIpEnable = @{
    "enableIpAccessLists" = "True"
} | ConvertTo-Json

$bodySoCo = @{
    "label"        = "SoCo Gateway"
    "list_type"    = "ALLOW"
    "ip_addresses" = "146.126.51.51", "146.126.61.241"
} | ConvertTo-Json

$bodyADF = @{
    "label"        = "Azure Data Factory"
    "list_type"    = "ALLOW"
    "ip_addresses" = "20.42.2.0/23", "20.42.4.0/26", "20.42.64.0/28", "20.49.111.0/29", "20.119.28.57/32", "40.71.14.32/28", "40.78.229.96/28"
} | ConvertTo-Json

$bodyADD = @{
    "label"        = "Azure AD"
    "list_type"    = "ALLOW"
    "ip_addresses" = "13.64.151.161/32", "13.66.141.64/27", "13.67.9.224/27", "13.69.66.160/27", "13.69.229.96/27", "13.70.73.32/27", "13.71.172.160/27", "13.71.195.224/27", "13.71.201.64/26", "13.73.240.32/27", "13.74.104.0/26", "13.74.249.156/32", "13.75.38.32/27", "13.75.105.168/32", "13.77.52.160/27", "13.78.108.192/27", "13.78.172.246/32", "13.79.37.247/32", "13.86.219.0/27", "13.87.16.0/26", "13.87.57.160/27", "13.87.123.160/27", "13.89.174.0/27", "20.20.32.0/19", "20.36.107.192/27", "20.36.115.64/27", "20.37.75.96/27", "20.40.228.64/28", "20.43.120.32/27", "20.44.3.160/27", "20.44.16.32/27", "20.46.10.64/27", "20.51.9.80/28", "20.51.14.72/31", "20.51.16.128/27", "20.61.98.160/27", "20.61.99.128/28", "20.62.58.80/28", "20.62.129.0/27", "20.62.129.240/28", "20.62.134.74/31", "20.65.132.96/28", "20.66.2.32/27", "20.66.3.16/28", "20.72.21.64/26", "20.88.66.0/27", "20.187.197.32/27", "20.187.197.240/28", "20.190.128.0/18", "20.194.73.0/28", "20.195.56.102/32", "20.195.57.118/32", "20.195.64.192/27", "20.195.64.240/28", "20.231.128.0/19", "23.101.0.70/32", "23.101.6.190/32", "40.68.160.142/32", "40.69.107.160/27", "40.71.13.0/27", "40.74.101.64/27", "40.74.146.192/27", "40.78.195.160/27", "40.78.203.64/27", "40.79.131.128/27", "40.79.179.128/27", "40.83.144.56/32", "40.126.0.0/18", "51.140.148.192/27", "51.140.208.0/26", "51.140.211.192/27", "52.138.65.157/32", "52.138.68.41/32", "52.146.132.96/27", "52.146.133.80/28", "52.146.137.66/31", "52.150.157.0/27", "52.159.175.31/32", "52.161.13.71/32", "52.161.13.95/32", "52.161.110.169/32", "52.162.110.96/27", "52.169.125.119/32", "52.169.218.0/32", "52.174.189.149/32", "52.175.18.134/32", "52.178.27.112/32", "52.179.122.218/32", "52.179.126.223/32", "52.180.177.87/32", "52.180.179.108/32", "52.180.181.61/32", "52.180.183.8/32", "52.187.19.1/32", "52.187.113.48/32", "52.187.117.83/32", "52.187.120.237/32", "52.225.184.198/32", "52.225.188.89/32", "52.226.169.40/32", "52.231.19.128/27", "52.231.147.192/27", "65.52.251.96/27", "104.40.84.19/32", "104.40.87.209/32", "104.40.156.18/32", "104.40.168.0/26", "104.41.159.212/32", "104.45.138.161/32", "104.46.178.128/27", "104.211.147.160/27", "191.233.204.160/27"
} | ConvertTo-Json

$bodyPowerBI = @{
    "label"        = "PowerBI"
    "list_type"    = "ALLOW"
    "ip_addresses" = "4.232.98.108/31", "4.232.98.160/30", "4.232.98.168/29", "13.73.248.4/31", "13.73.248.48/28", "13.73.248.64/27", "20.14.120.8/29", "20.14.121.160/29", "20.14.121.184/29", "20.17.54.170/31", "20.17.54.172/30", "20.17.54.176/29", "20.21.32.22/31", "20.21.36.124/30", "20.21.37.48/29", "20.21.55.216/29", "20.21.80.22/31", "20.21.83.144/29", "20.26.18.114/31", "20.26.18.120/30", "20.36.120.122/31", "20.36.120.124/30", "20.36.120.208/29", "20.37.64.122/31", "20.37.64.124/30", "20.37.64.208/29", "20.37.156.200/30", "20.37.156.240/28", "20.37.157.0/29", "20.37.157.16/28", "20.37.157.32/27", "20.37.195.24/31", "20.37.195.48/29", "20.37.195.64/28", "20.37.195.128/26", "20.37.224.122/31", "20.37.224.124/30", "20.37.224.208/29", "20.38.84.104/31", "20.38.84.128/25", "20.38.85.0/25", "20.38.86.0/24", "20.38.136.70/31", "20.38.136.208/30", "20.38.136.216/29", "20.39.11.26/31", "20.39.11.28/30", "20.39.11.48/28", "20.40.230.60/30", "20.41.4.104/31", "20.41.4.108/30", "20.41.4.208/28", "20.41.4.224/27", "20.41.5.0/25", "20.41.65.146/31", "20.41.65.148/30", "20.41.65.152/29", "20.41.192.122/31", "20.41.192.124/30", "20.41.193.144/29", "20.42.0.70/31", "20.42.4.240/29", "20.42.6.0/27", "20.42.6.64/26", "20.42.131.32/31", "20.42.131.40/29", "20.42.131.48/29", "20.42.131.128/26", "20.42.224.122/31", "20.42.227.16/28", "20.42.227.32/29", "20.42.227.64/26", "20.43.41.176/31", "20.43.41.184/29", "20.43.41.192/26", "20.43.65.152/31", "20.43.65.176/29", "20.43.65.192/28", "20.43.65.224/27", "20.43.130.192/31", "20.43.130.196/30", "20.43.130.200/29", "20.43.130.208/28", "20.43.130.224/28", "20.43.131.0/27", "20.43.131.64/26", "20.45.90.88/30", "20.45.94.80/29", "20.45.192.122/31", "20.45.192.124/31", "20.45.192.208/30", "20.45.192.216/29", "20.45.192.224/28", "20.45.242.48/29", "20.46.15.56/30", "20.47.233.72/29", "20.48.196.232/29", "20.48.197.124/30", "20.48.202.16/29", "20.48.202.24/30", "20.50.0.0/24", "20.51.0.204/30", "20.51.1.32/28", "20.51.5.4/30", "20.51.5.192/26", "20.51.14.76/31", "20.51.21.160/29", "20.51.21.176/29", "20.51.21.240/29", "20.52.89.48/30", "20.52.95.0/29", "20.53.49.108/30", "20.53.53.192/29", "20.59.79.96/27", "20.59.79.192/28", "20.65.133.80/29", "20.65.134.192/27", "20.65.134.224/28", "20.65.134.240/30", "20.65.135.16/28", "20.69.4.224/28", "20.69.4.240/30", "20.70.221.0/28", "20.70.221.224/27", "20.72.16.22/31", "20.72.16.44/30", "20.72.20.32/29", "20.74.196.94/31", "20.74.197.64/30", "20.83.221.80/30", "20.83.221.84/31", "20.83.221.208/29", "20.86.93.192/28", "20.86.93.208/29", "20.87.80.8/29", "20.88.154.0/29", "20.88.157.72/29", "20.88.157.96/27", "20.89.11.112/30", "20.89.11.116/31", "20.89.11.248/29", "20.90.32.144/28", "20.90.36.40/29", "20.90.36.96/28", "20.90.36.112/30", "20.90.131.116/30", "20.90.132.64/28", "20.92.4.144/28", "20.97.33.248/29", "20.97.34.128/26", "20.97.34.192/28", "20.98.145.48/28", "20.98.145.64/30", "20.98.145.112/29", "20.98.146.0/27", "20.98.192.168/30", "20.98.192.192/27", "20.98.193.128/26", "20.98.193.192/29", "20.98.199.116/31", "20.99.11.4/30", "20.99.11.8/29", "20.100.1.168/29", "20.100.2.40/29", "20.105.209.128/25", "20.111.0.192/29", "20.119.156.32/27", "20.119.157.64/28", "20.125.157.32/31", "20.150.160.110/31", "20.150.160.124/30", "20.150.161.144/29", "20.175.2.248/31", "20.175.5.152/29", "20.175.6.192/27", "20.175.6.224/28", "20.189.104.70/31", "20.189.106.224/27", "20.189.108.0/27", "20.189.193.176/29", "20.191.167.244/31", "20.192.47.128/30", "20.192.47.132/31", "20.192.82.20/30", "20.192.82.120/29", "20.192.84.128/29", "20.192.152.144/30", "20.192.153.88/30", "20.192.159.72/29", "20.192.160.22/31", "20.192.161.112/30", "20.192.161.120/29", "20.192.168.144/30", "20.192.169.120/30", "20.192.174.212/30", "20.192.174.224/27", "20.192.175.0/27", "20.192.225.34/31", "20.192.225.36/30", "20.192.225.192/29", "20.195.83.48/29", "20.195.85.16/30", "20.195.85.32/27", "20.195.146.200/30", "20.199.201.80/29", "20.200.192.8/30", "20.200.192.14/31", "20.200.194.232/30", "20.200.195.176/30", "20.200.198.8/30", "20.205.49.48/28", "20.205.49.64/28", "20.205.68.120/29", "20.205.69.0/28", "20.206.0.96/29", "20.206.178.24/29", "20.206.178.48/29", "20.206.178.64/27", "20.207.168.148/30", "20.207.168.160/28", "20.208.7.144/29", "20.208.148.48/28", "20.208.149.64/27", "20.211.229.128/26", "20.213.198.0/26", "20.215.4.248/31", "20.215.4.252/30", "20.215.6.128/29", "20.215.170.120/29", "20.217.44.248/31", "20.217.44.252/30", "20.217.46.128/29", "40.67.50.246/31", "40.74.24.70/31", "40.74.30.128/29", "40.74.30.160/27", "40.74.30.192/26", "40.74.31.0/26", "40.80.56.122/31", "40.80.57.144/29", "40.80.57.160/28", "40.80.168.122/31", "40.80.168.124/30", "40.80.169.144/29", "40.80.184.70/31", "40.80.188.48/28", "40.80.188.64/27", "40.80.188.128/25", "40.80.189.0/24", "40.82.248.68/31", "40.82.253.96/28", "40.82.253.128/26", "40.82.254.0/25", "40.89.16.122/31", "40.89.17.144/28", "40.89.17.160/27", "40.117.25.224/28", "40.119.8.76/30", "40.119.11.64/26", "40.120.82.124/30", "40.120.86.144/31", "40.120.86.148/30", "40.120.87.52/30", "51.12.17.16/30", "51.12.17.24/29", "51.12.17.246/31", "51.12.22.168/30", "51.12.22.200/30", "51.12.25.8/29", "51.12.29.30/31", "51.12.46.230/31", "51.12.47.28/30", "51.12.72.216/30", "51.12.73.88/30", "51.12.198.210/31", "51.13.138.72/30", "51.13.143.0/29", "51.53.28.212/31", "51.53.30.152/30", "51.53.30.160/29", "51.53.172.212/31", "51.53.172.216/30", "51.53.174.144/29", "51.104.25.140/31", "51.104.25.152/30", "51.104.25.176/28", "51.104.25.192/29", "51.104.27.0/26", "51.105.88.122/31", "51.105.88.124/30", "51.105.88.208/28", "51.107.48.124/31", "51.107.48.208/30", "51.107.48.216/29", "51.107.144.122/31", "51.107.144.124/30", "51.107.144.208/29", "51.107.243.168/30", "51.107.247.224/29", "51.107.251.184/30", "51.107.255.128/29", "51.116.48.68/31", "51.116.48.128/30", "51.116.48.136/29", "51.116.55.168/30", "51.116.75.72/29", "51.116.144.68/31", "51.116.144.128/30", "51.116.144.136/29", "51.116.149.232/29", "51.120.40.124/31", "51.120.40.208/30", "51.120.40.216/29", "51.120.224.122/31", "51.120.224.124/30", "51.120.224.208/29", "51.120.237.12/30", "51.137.160.70/31", "51.137.161.160/27", "51.137.161.192/27", "51.138.215.114/31", "51.138.215.116/30", "51.138.215.120/31", "52.136.48.120/31", "52.136.48.124/30", "52.136.48.208/29", "52.136.48.224/28", "52.136.186.112/30", "52.136.190.184/29", "52.139.108.116/30", "52.140.105.144/28", "52.140.105.160/28", "52.146.140.128/25", "52.147.113.176/30", "52.147.119.8/29", "52.150.139.76/31", "52.150.139.96/30", "52.150.139.112/28", "52.150.139.128/28", "52.150.139.160/27", "52.159.201.0/25", "52.172.116.184/30", "52.172.116.190/31", "52.228.81.160/31", "52.228.81.168/29", "52.228.81.176/28", "52.228.81.192/27", "52.242.40.92/30", "52.242.40.96/29", "52.242.47.40/30", "52.242.47.96/29", "68.219.160.0/25", "68.221.92.4/31", "68.221.93.136/30", "68.221.93.144/29", "102.37.81.140/30", "102.37.85.208/29", "102.37.160.160/29", "102.37.163.20/30", "102.133.56.98/31", "102.133.56.100/30", "102.133.56.104/29", "102.133.216.104/31", "102.133.216.108/30", "102.133.217.64/29", "158.23.109.128/31", "158.23.109.132/30", "158.23.109.136/29", "191.233.8.22/31", "191.233.10.32/30", "191.233.10.40/29", "191.235.225.152/31", "191.235.225.156/30", "191.235.225.176/28", "191.235.225.192/28", "191.235.225.224/27", "191.238.72.128/28", "191.238.76.176/29", "191.238.77.192/28", "191.238.77.208/29", "191.238.77.216/30"
} | ConvertTo-Json


$bodyNATPublicIP = @{
    "label"        = "NAT Public"
    "list_type"    = "ALLOW"
    "ip_addresses" = $NATPublicIP
} | ConvertTo-Json

[Net.ServicePointManager]::SecurityProtocol = [Net.SecurityProtocolType]::Tls -bor [Net.SecurityProtocolType]::Tls11 -bor [Net.SecurityProtocolType]::Tls12

# Function to print current IP Access Lists
function Print-CurrentIPAccessLists {
    $response = (Invoke-WebRequest -Uri ($DatabricksWorkspace + "api/2.0/ip-access-lists") -Method Get -Headers $header).Content | ConvertFrom-Json
    Write-Host "Current IP Access Lists:"
    foreach ($list in $response.ip_access_lists) {
        Write-Host "  Label: $($list.label)"
        Write-Host "    List Type: $($list.list_type)"
        Write-Host "    IP Addresses: $($list.ip_addresses -join ', ')"
        Write-Host ""
    }
}

# =-> ENABLE IP ACCESS LIST
$response = (Invoke-WebRequest -Uri ($DatabricksWorkspace + "api/2.0/workspace-conf?keys=enableIpAccessLists") -Method Get -Headers $header).Content | ConvertFrom-Json
Write-Host "IP Access List: " $response.enableIpAccessLists
if ($response.enableIpAccessLists -eq "false" -Or $response.enableIpAccessLists -eq $null) {
    Write-Host "*** Enabling IP Access List"
    Invoke-WebRequest -Uri ($DatabricksWorkspace + "api/2.0/workspace-conf")  -Method Patch -Headers $header -Body $bodyIpEnable
}

Write-Host "**************Existing IP Access Lists before changes:**************************"
Print-CurrentIPAccessLists
Write-Host "*********************************************************************************"
Write-Host "*********************************************************************************"
# =-> CREATE LIST - IF DOESN'T EXIST
$response = (Invoke-WebRequest -Uri ($DatabricksWorkspace + "api/2.0/ip-access-lists") -Method Get -Headers $header).Content | ConvertFrom-Json
$response.ip_access_lists.label

# SoCo 
if ($response.ip_access_lists.label -eq $null -Or !$response.ip_access_lists.label.Contains("SoCo Gateway")) { Invoke-WebRequest -Uri ($DatabricksWorkspace + "api/2.0/ip-access-lists")  -Method Post -Headers $header -Body $bodySoCo }
# ADF
$response.ip_access_lists | ForEach-Object -Process { if ($_.label -eq "Azure Data Factory") { Write-Host "Deleting IP Access List" $_.label; Invoke-WebRequest -Uri ($DatabricksWorkspace + "api/2.0/ip-access-lists/" + $_.list_id) -Method Delete -Headers $header } }
Invoke-WebRequest -Uri ($DatabricksWorkspace + "api/2.0/ip-access-lists")  -Method Post -Headers $header -Body $bodyADF
# Azure AD
$response.ip_access_lists | ForEach-Object -Process { if ($_.label -eq "Azure AD") { Write-Host "Deleting IP Access List " $_.label; Invoke-WebRequest -Uri ($DatabricksWorkspace + "api/2.0/ip-access-lists/" + $_.list_id) -Method Delete -Headers $header } }
Invoke-WebRequest -Uri ($DatabricksWorkspace + "api/2.0/ip-access-lists")  -Method Post -Headers $header -Body $bodyADD
# PowerBI
if ($EnablePowerBI -eq 1) {
    $response.ip_access_lists | ForEach-Object -Process { if ($_.label -eq "PowerBI") { Write-Host "Deleting IP Access List " $_.label; Invoke-WebRequest -Uri ($DatabricksWorkspace + "api/2.0/ip-access-lists/" + $_.list_id) -Method Delete -Headers $header } }
    Invoke-WebRequest -Uri ($DatabricksWorkspace + "api/2.0/ip-access-lists")  -Method Post -Headers $header -Body $bodyPowerBI
}
# NAT Public IP
if ($NATPublicIP) {
    $response.ip_access_lists | ForEach-Object -Process {
        if ($_.label -eq "NAT Public") {
            Write-Host "Deleting IP Access List " $_.label
            Invoke-WebRequest -Uri ($DatabricksWorkspace + "api/2.0/ip-access-lists/" + $_.list_id) -Method Delete -Headers $header
        }
    }
    Write-Host "Adding NAT Public to IP Access List"
    Invoke-WebRequest -Uri ($DatabricksWorkspace + "api/2.0/ip-access-lists") -Method Post -Headers $header -Body $bodyNATPublicIP
}


# Print updated IP Access Lists after making changes
Write-Host "Updated IP Access Lists after changes:"
Print-CurrentIPAccessLists